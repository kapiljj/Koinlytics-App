<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Asset Details - Koinlytics</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #111827; color: #F9FAFB; }
        .card { background-color: #1F2937; border: 1px solid #374151; border-radius: 0.75rem; }
        .btn { transition: all 0.2s; }
        .btn:hover { transform: translateY(-2px); }
        .loader { border: 4px solid #4B5563; border-top: 4px solid #3B82F6; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .hidden { display: none; }
    </style>
</head>
<body class="p-4 sm:p-6 md:p-8">
    <div class="max-w-7xl mx-auto min-h-screen flex flex-col">
        <header class="mb-8 flex justify-between items-center">
            <div>
                <h1 class="text-3xl sm:text-4xl font-bold text-white">Koinlytics</h1>
                <p id="user-email" class="text-sm text-gray-400 mt-1"></p>
            </div>
            <div>
                <button id="back-to-portfolio-button" class="btn bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg mr-4">Back to Portfolio</button>
                <button id="logout-button" class="btn bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg">Logout</button>
            </div>
        </header>
        <main class="flex-grow">
            <div id="loader-container" class="h-96 flex items-center justify-center card"><div class="text-center"><div class="loader mx-auto"></div><p class="mt-4 text-gray-400">Loading asset details...</p></div></div>
            <div id="asset-detail-content" class="hidden"></div>
        </main>
    </div>
<script>
document.addEventListener('DOMContentLoaded', () => {
    const API_URL = 'http://localhost:8080/api';
    let userSession = null;
    let priceHistoryChart = null;

    const init = () => {
        const sessionJson = localStorage.getItem('koinlytics_session');
        if (sessionJson) {
            userSession = JSON.parse(sessionJson);
            document.getElementById('user-email').textContent = `Logged in as: ${userSession.session.user.email}`;
            const urlParams = new URLSearchParams(window.location.search);
            const coinId = urlParams.get('coinId');
            if (coinId) {
                renderAssetDetail(coinId);
            } else {
                document.getElementById('asset-detail-content').innerHTML = `<div class="card p-6 text-center text-red-500">No asset specified.</div>`;
                document.getElementById('loader-container').classList.add('hidden');
            }
        } else {
            window.location.href = './index.html';
        }
        addEventListeners();
    };

    const renderAssetDetail = async (coinId) => {
        const assetDetailContent = document.getElementById('asset-detail-content');
        try {
            const [detailsRes, historyRes, transactionsRes] = await Promise.all([
                fetch(`${API_URL}/coin-details/${coinId}`),
                fetch(`${API_URL}/historical-data-24h/${coinId}`),
                fetch(`${API_URL}/transactions/${coinId}`)
            ]);
            if (!detailsRes.ok) throw new Error('Market data not available');
            const details = await detailsRes.json();
            const history = await historyRes.json();
            const transactions = await transactionsRes.json();
            const change24h = details.price_change_percentage_24h || 0;
            const changeColor = change24h >= 0 ? 'text-green-400' : 'text-red-400';
            assetDetailContent.innerHTML = `
                <div class="card p-6">
                    <div class="flex justify-between items-center mb-4">
                        <div class="flex items-center">
                            <img src="${details.image}" class="w-12 h-12 mr-4 rounded-full" alt="${details.name} logo">
                            <div><h2 class="text-3xl font-bold">${details.name} <span class="text-gray-400 uppercase">${details.symbol}</span></h2></div>
                        </div>
                        <div class="text-right">
                            <p class="text-2xl font-bold">${formatCurrency(details.current_price)}</p>
                            <p class="${changeColor} font-semibold">${change24h.toFixed(2)}% (24h)</p>
                        </div>
                    </div>
                    <div class="h-80 mb-8"><canvas id="price-history-chart-24h"></canvas></div>
                    <h3 class="text-xl font-semibold mb-4">Recent Transactions (Mock)</h3>
                    <div class="space-y-2">${transactions.map(tx => `<div class="p-3 bg-gray-800 rounded-md flex justify-between items-center"><div><p class="font-semibold">${tx.type} <span class="text-gray-400">from ${tx.source}</span></p><p class="text-sm text-gray-500">${tx.date}</p></div><p class="font-mono ${tx.type === 'Sell' ? 'text-red-400' : 'text-green-400'}">${tx.type === 'Sell' ? '-' : '+'}${tx.amount} ${details.symbol.toUpperCase()}</p></div>`).join('')}</div>
                </div>
            `;
            renderPriceHistoryChart(history.prices);
        } catch (error) {
            console.error('Failed to render asset detail', error);
            assetDetailContent.innerHTML = `<div class="card p-6 text-center text-yellow-400">Market data not available for this asset.</div>`;
        } finally {
            document.getElementById('loader-container').classList.add('hidden');
            assetDetailContent.classList.remove('hidden');
        }
    };

    const addEventListeners = () => {
        document.getElementById('logout-button').addEventListener('click', () => { localStorage.removeItem('koinlytics_session'); window.location.href = './index.html'; });
        document.getElementById('back-to-portfolio-button').addEventListener('click', () => { window.location.href = './dashboard.html'; });
    };

    const renderPriceHistoryChart = (prices) => {
        const ctx = document.getElementById('price-history-chart-24h')?.getContext('2d');
        if (!ctx) return;
        if (priceHistoryChart) priceHistoryChart.destroy();
        priceHistoryChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: prices.map(p => p[0]),
                datasets: [{
                    label: 'Price (USD)',
                    data: prices.map(p => p[1]),
                    borderColor: '#3B82F6',
                    tension: 0.1,
                    fill: true,
                    backgroundColor: 'rgba(59, 130, 246, 0.1)',
                    pointRadius: 0
                }]
            },
            options: { responsive: true, maintainAspectRatio: false, scales: { x: { type: 'time', time: { unit: 'hour' }, ticks: { color: '#9CA3AF' } }, y: { ticks: { color: '#9CA3AF' } } }, plugins: { legend: { display: false } } }
        });
    };

    const formatCurrency = (value) => new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' }).format(value);
    init();
});
</script>
</body>
</html>
